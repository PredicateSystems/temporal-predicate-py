version: "3.8"

services:
  # Predicate Authority Sidecar - the authorization engine
  sidecar:
    build:
      context: ../..
      dockerfile: examples/demo/Dockerfile.sidecar
    ports:
      - "8787:8787"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8787/health || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 5s
    networks:
      - demo-net

  # Temporal server (dev mode)
  temporal:
    image: temporalio/auto-setup:latest
    ports:
      - "7233:7233"
    environment:
      - DB=sqlite
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
    healthcheck:
      test: ["CMD-SHELL", "temporal operator namespace describe default || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s
    networks:
      - demo-net

  # Demo application - shows hack vs fix scenarios
  demo:
    build:
      context: ../..
      dockerfile: examples/demo/Dockerfile.demo
    environment:
      SIDECAR_URL: http://sidecar:8787
      TEMPORAL_ADDRESS: temporal:7233
    depends_on:
      sidecar:
        condition: service_healthy
      temporal:
        condition: service_healthy
    networks:
      - demo-net

networks:
  demo-net:
    driver: bridge
